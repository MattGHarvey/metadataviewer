<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>JPG Metadata Viewer</title>
		<link
			rel="icon"
			type="image/jpeg"
			href="https://robotsprocket.com/wp-content/uploads/2021/11/icon_med-250x250.jpg"
		/>
		<script>
			fetch("ga-snippet.html")
				.then((response) => (response.ok ? response.text() : ""))
				.then((html) => {
					if (html) {
						const gaDiv = document.createElement("div");
						gaDiv.innerHTML = html;
						document.head.append(...gaDiv.childNodes);
					}
				});
		</script>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		/>
		<style>
			html,
			body {
				font-family: "Segoe UI", "Helvetica Neue", Arial,
					"Liberation Sans", sans-serif;
			}
			#drop-area {
				border: 2px dashed #ccc;
				border-radius: 20px;
				width: 400px;
				height: 200px;
				margin: 50px auto;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 1.2em;
				color: #888;
			}
			#image-preview {
				width: 80%;
				margin: 20px auto;
				text-align: center;
			}
			#metadata {
				width: 80%;
				margin: 20px auto;
				background: #f9f9f9;
				padding: 20px;
				border-radius: 10px;
				font-family: monospace;
				white-space: pre-wrap;
			}
			#metadata table {
				font-size: 2.15em;
				width: 100%;
				border-collapse: collapse;
			}
			#metadata th,
			#metadata td {
				border: 1px solid #ccc;
				padding: 8px;
				text-align: left;
			}
			#metadata th {
				background-color: #f2f2f2;
			}
			#map {
				width: 80%;
				height: 500px;
				margin: 20px auto;
				border-radius: 10px;
				border: 1px solid #ccc;
				display: none;
			}
		</style>
	</head>
	<body>
		<div
			style="
				width: 80%;
				margin: 20px auto 0 auto;
				padding: 10px 20px;
				background: #eaf6ff;
				border-radius: 10px;
				border: 1px solid #b3d8ff;
				font-size: 1.1em;
				color: #333;
			"
		>
			<strong>Privacy Notice:</strong> All processing is done entirely in
			your browser. Your photos are never uploaded to any server.
		</div>
		<div id="drop-area">Drop JPG file here</div>
		<div style="width: 80%; margin: 10px auto; text-align: center">
			<label for="file-picker" style="font-size: 1.1em"
				>Or select a JPG file:</label
			>
			<input
				type="file"
				id="file-picker"
				accept="image/jpeg"
				style="margin-left: 10px"
			/>
		</div>
		<div
			id="image-preview"
			style="width: 80%; margin: 20px auto; text-align: center"
		></div>
		<div id="metadata"></div>
		<div id="map"></div>
		<footer
			style="
				width: 80%;
				margin: 40px auto 0 auto;
				padding: 16px 0;
				text-align: center;
				font-size: 1em;
				color: #555;
			"
		>
			&copy; 2025 Matt Harvey &mdash;
			<a
				href="https://www.robotsprocket.com"
				target="_blank"
				rel="noopener"
				style="color: #1976d2; text-decoration: none"
				>[robotSprocket]</a
			>
			&mdash;
			<a
				href="https://www.75centralphotography.com"
				target="_blank"
				rel="noopener"
				style="color: #1976d2; text-decoration: none"
				>75CentralPhotography</a
			>
		</footer>
		<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script>
			const dropArea = document.getElementById("drop-area");
			const metadataDiv = document.getElementById("metadata");
			const mapDiv = document.getElementById("map");
			const imagePreviewDiv = document.getElementById("image-preview");
			const filePicker = document.getElementById("file-picker");

			function dmsToDecimal(dms, ref) {
				if (!Array.isArray(dms) || dms.length !== 3) return null;
				const [deg, min, sec] = dms;
				let dec = deg + min / 60 + sec / 3600;
				if (ref === "S" || ref === "W") dec = -dec;
				return dec;
			}

			function handleFile(file) {
				if (!file || file.type !== "image/jpeg") {
					metadataDiv.textContent = "Please select a JPG file.";
					mapDiv.style.display = "none";
					imagePreviewDiv.innerHTML = "";
					return;
				}
				// Display image preview
				const imgUrl = URL.createObjectURL(file);
				imagePreviewDiv.innerHTML = `<img src="${imgUrl}" alt="Preview" style="max-width:100%;max-height:400px;border-radius:10px;border:1px solid #ccc;box-shadow:0 2px 8px #ccc;" />`;
				const reader = new FileReader();
				reader.onload = function (event) {
					const arrayBuffer = event.target.result;
					let exifData = {};
					try {
						exifData = EXIF.readFromBinaryFile(arrayBuffer);
					} catch (err) {
						exifData = { error: "Error reading EXIF: " + err };
					}
					if (
						typeof exifData === "object" &&
						exifData !== null &&
						!exifData.error
					) {
						let table =
							'<table style="width:100%;border-collapse:collapse;">';
						for (const key in exifData) {
							if (
								Object.prototype.hasOwnProperty.call(
									exifData,
									key
								) &&
								key !== "thumbnail"
							) {
								let value = exifData[key];
								if (typeof value === "string") {
									try {
										// Attempt to decode as UTF-8 if it contains replacement characters
										if (value.includes("\uFFFD")) {
											const decoder = new TextDecoder(
												"utf-8"
											);
											value = decoder.decode(
												new Uint8Array(
													[...value].map((c) =>
														c.charCodeAt(0)
													)
												)
											);
										}
									} catch {}
								}
								table += `<tr><td style='border:1px solid #ccc;padding:4px;'><strong>${key}</strong></td><td style='border:1px solid #ccc;padding:4px;'>${value}</td></tr>`;
							}
						}
						table += "</table>";
						metadataDiv.innerHTML =
							"<strong>EXIF Metadata:</strong>" + table;

						// Show map if GPS data exists
						if (
							exifData.GPSLatitude &&
							exifData.GPSLongitude &&
							exifData.GPSLatitudeRef &&
							exifData.GPSLongitudeRef
						) {
							const lat = dmsToDecimal(
								exifData.GPSLatitude,
								exifData.GPSLatitudeRef
							);
							const lng = dmsToDecimal(
								exifData.GPSLongitude,
								exifData.GPSLongitudeRef
							);
							if (lat !== null && lng !== null) {
								mapDiv.style.display = "block";
								mapDiv.innerHTML = "";
								const map = L.map("map").setView(
									[lat, lng],
									13
								);
								L.tileLayer(
									"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
									{
										maxZoom: 19,
										attribution:
											"Â© OpenStreetMap contributors",
									}
								).addTo(map);
								L.marker([lat, lng])
									.addTo(map)
									.bindPopup("Photo Location")
									.openPopup();
							} else {
								mapDiv.style.display = "none";
							}
						} else {
							mapDiv.style.display = "none";
						}
					} else {
						metadataDiv.innerHTML =
							"<strong>EXIF Metadata:</strong><pre>" +
							JSON.stringify(exifData, null, 2) +
							"</pre>";
						mapDiv.style.display = "none";
					}
				};
				reader.onerror = function () {
					metadataDiv.textContent = "Error reading file.";
					mapDiv.style.display = "none";
				};
				reader.readAsArrayBuffer(file);
			}

			filePicker.addEventListener("change", (e) => {
				if (e.target.files && e.target.files[0]) {
					handleFile(e.target.files[0]);
				}
			});
			dropArea.addEventListener("dragover", (e) => {
				e.preventDefault();
				dropArea.style.background = "#e0e0e0";
			});
			dropArea.addEventListener("dragleave", (e) => {
				e.preventDefault();
				dropArea.style.background = "";
			});
			dropArea.addEventListener("drop", (e) => {
				e.preventDefault();
				dropArea.style.background = "";
				if (e.dataTransfer.files && e.dataTransfer.files[0]) {
					handleFile(e.dataTransfer.files[0]);
				}
			});
		</script>
	</body>
</html>
